/**
 * 
 */
$(function() {
   const cPath = $(this.body).data("contextPath");
   let makeTrTag = function(adrsVO) {
      let trTag = `
            <tr data-adrs-no="${adrsVO.adrsNo}">
               <td>${adrsVO.adrsName}</td>
               <td>${adrsVO.adrsHp}</td>
               <td>${adrsVO.adrsAdd}</td>
               <td><input type="button" value="삭제" class="delBtn"/></td>
               <td><input type="button" value="수정" class="modBtn" data-bs-toggle="modal" data-bs-target="#exampleModal"/></td>
            </tr>
            
            
         `;
      return trTag;
   }; //makeTags end

   const baseUrl = `${cPath}/adrs/address`;

   $.getJSON(baseUrl, function(resp) {
      let adrsList = resp.adrsList;
      trTags = "";
      if (adrsList?.length > 0) {         //adrList가 있고 length가 0보다 크다
         $.each(adrsList, function() {
            trTags += makeTrTag(this);
         });
      } else {
         trTags += `
            <tr>
               <td colspan="3">주소록 없음.</td>
            </tr>
         
         `;
      }// if ~ else end

      $(listBody).html(trTags);
   });// getJSON end

   $(adrsForm).on("submit", function(event) {
      event.preventDefault();
      let url = this.action;
      let method = this.method;
      let data = $(this).serializeJSON(); // 직렬화
      let json = JSON.stringify(data); // 마샬링

      let settings = {
         url: baseUrl,
         method: method,
         data: json,
         headers: {
            "Content-Type": "application/json;charset=utf-8"
         },
         dataType: "json"

      };

      $.ajax(settings)
         .done(function(resp) {    //success 함수 대신 done 사용
            if (resp.success) {
               let trTag = makeTrTag(resp.originalData);
               $(listBody).prepend(trTag);
               adrsForm.reset();  // jquery에는 reset이 없어서 dom 으로 사용함.
            } else {
               alert(resp.message);
            }
         });
      return false;
   });


   $("#listBody").on("click", ".delBtn", function() {
      let flag = confirm("정말 삭제하시겠습니까?");
      if (!flag) return false;
      let adrsTr = $(this).parents("tr:first");   // tr 안에서 first를 찾는다.
      let $adrsTr = $(adrsTr);
      let adrsNo = $adrsTr.data("adrsNo");
      let url = `${baseUrl}/${adrsNo}`;
      let settings = {
         url: url,
         method: "delete",
         dataType: "json"
      };

      $.ajax(settings)
         .done(function(resp) {
            if (resp.success) {
               $adrsTr.remove();
            } else {
               alert(resp.message);
            }
         });
   });
   
   
   $(listBody).on("click", ".modBtn", function() {
       let adrsNo = $(this).parents('tr').data("adrsNo");
       let adrsName = $(this).parents('tr').find('td:eq(0)').text();
       let adrsHp = $(this).parents('tr').find('td:eq(1)').text();
       let adrsAdd = $(this).parents('tr').find('td:eq(2)').text();
      
      
      $("#Name").val(adrsName);
      $("#No").val(adrsNo);
      $("#Hp").val(adrsHp);
      $("#Add").val(adrsAdd);

      //      let adrsHp = $(this).parents("td:second");
      //   let adrsAdd = $(this).parents("td:third");

      console.log(adrsNo, adrsName, adrsHp, adrsAdd);
   });


   $(modify).on('click', function() {
      let flag = confirm("정말 수정하시겠습니까?");
      if (!flag) {return false;}
      
      let data = $("#modForm").serializeJSON();
      let json = JSON.stringify(data);
      
      console.log(json);
      let settings = {
         url: baseUrl,
         method: "put",
         data: json,
         contentType: 'application/json;charset=utf-8',
         dataType: 'json'
      };

      $.ajax(settings)
         .done(function(resp) {
            if (resp.success) {
                $(this).parents('tr').find('td:eq(0)').text(resp.modify.adrsName);
                $(this).parents('tr').find('td:eq(1)').text(resp.modify.adrsHp);
                $(this).parents('tr').find('td:eq(2)').text(resp.modify.adrsAdd);
                adrsForm.reset();
            } else {
               alert(resp.message);
            }
         });



   });

}); //function end



