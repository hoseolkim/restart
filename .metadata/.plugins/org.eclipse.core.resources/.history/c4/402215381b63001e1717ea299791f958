<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.prod.dao.ProdDAO">
	<resultMap type="ProdVO" id="prod" autoMapping="true">
		<id property="prodId" column="PROD_ID" />
		<association property="lprod" autoMapping="true" />
		<association property="buyer" autoMapping="true" />
		<collection property="cartList" ofType="CartVO" autoMapping="true">
<!-- 			<id property="memId" column="MEM_ID"/> -->
				<association property="member" autoMapping="true" />
		</collection>
	</resultMap>
	<sql id="searchFrag">
		<where>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(simpleCondition.searchWord)">
				<choose>
					<when test="simpleCondition.searchType eq 'prodLgu'">
						INSTR(PROD_LGU, #{simpleCondition.searchWord} ) > 0
					</when>
					<when test="simpleCondition.searchType eq 'prodBuyer'">
						INSTR(PROD_BUYER, #{simpleCondition.searchWord} ) > 0
					</when>
					<otherwise>
						INSTR(PROD_LGU, #{simpleCondition.searchWord} ) > 0
					OR
						INSTR(PROD_BUYER, #{simpleCondition.searchWord} ) > 0
					</otherwise>
				</choose>
			</if>
		</where>
	</sql>

	<select id="selectTotalRecord" resultType="int" parameterType="PaginationInfo">
		SELECT COUNT(*)
		FROM PROD INNER JOIN LPROD ON (PROD_LGU = LPROD_GU)
					INNER JOIN BUYER ON (PROD_BUYER = BUYER_ID)
			<include refid="searchFrag" />
	</select>
	<select id="selectProdList" resultType="ProdVO" parameterType="PaginationInfo">
		SELECT
			A.*
		FROM
		    (
		    WITH CARTVIEW AS(
		    	SELECT DISTINCT CART_PROD, CART_MEMBER FROM CART
		    ) 
		    SELECT
		    	ROWNUM RNUM
			    , PROD_ID
			    , PROD_NAME
			    , PROD_LGU
			    , PROD_BUYER
			    , PROD_COST
			    , PROD_PRICE
			    , PROD_SALE
			    , PROD_OUTLINE
			    , PROD_DETAIL
			    , PROD_IMG
			    , PROD_TOTALSTOCK
			    , PROD_INSDATE
			    , PROD_PROPERSTOCK
			    , PROD_SIZE
			    , PROD_COLOR
			    , PROD_DELIVERY
			    , PROD_UNIT
			    , PROD_QTYIN
			    , PROD_QTYSALE
			    , PROD_MILEAGE
			    , (SELECT COUNT(*) FROM CARTVIEW WHERE CART_PROD = PROD_ID ) BUYER_CNT
			    , BUYER_NAME "buyer.buyerName"
			    , LPROD_NM "lprod.lprodNm"
			FROM
			    PROD INNER JOIN LPROD ON(PROD_LGU = LPROD_GU)
			        INNER JOIN BUYER ON(PROD_BUYER = BUYER_ID)
			) A
		<![CDATA[
		WHERE
			RNUM >= #{startRow}
		AND
			RNUM <= #{endRow}
		]]>
	</select>





	<select id="selectProd" resultMap="prod" parameterType="String">
		WITH MEMBERVIEW AS(
			SELECT MEMBER.*, CART.* FROM CART INNER JOIN MEMBER ON(MEM_ID = CART_MEMBER)
		)
		SELECT
		    PROD_ID
		    , PROD_NAME
		    , PROD_LGU
		    , PROD_BUYER
		    , PROD_COST
		    , PROD_PRICE
		    , PROD_SALE
		    , PROD_OUTLINE
		    , PROD_DETAIL
		    , PROD_IMG
		    , PROD_TOTALSTOCK
		    , PROD_INSDATE
		    , PROD_PROPERSTOCK
		    , PROD_SIZE
		    , PROD_COLOR
		    , PROD_DELIVERY
		    , PROD_UNIT
		    , PROD_QTYIN
		    , PROD_QTYSALE
		    , PROD_MILEAGE
		    , BUYER_ID
		    , BUYER_NAME
		    , BUYER_LGU
		    , BUYER_BANK
		    , BUYER_BANKNO
		    , BUYER_BANKNAME
		    , BUYER_ZIP
		    , BUYER_ADD1
		    , BUYER_ADD2
		    , BUYER_COMTEL
		    , BUYER_FAX
		    , BUYER_MAIL
		    , BUYER_CHARGER
		    , BUYER_TELEXT
		    , LPROD_ID
		    , LPROD_GU
		    , LPROD_NM
            , MEM_NAME
            , MEM_HP
            , MEM_MAIL
            , MEM_ADD1
            , MEM_ADD2
            , MEM_MILEAGE
            , MEM_ID
            , CART_QTY
            , CART_NO
            , TO_DATE(SUBSTR(CART_NO,1,8),'YYYYMMDD') CART_DATE
		FROM
		    PROD INNER JOIN LPROD ON(PROD_LGU = LPROD_GU)
		        INNER JOIN BUYER ON(PROD_BUYER = BUYER_ID)
                LEFT OUTER JOIN MEMBERVIEW ON (PROD_ID = CART_PROD)
		WHERE
		    PROD_ID = #{prodId}
	</select>
</mapper>



<!-- 
SELECT
			A.*
		FROM
		    (
		    WITH CARTVIEW AS(
		    	SELECT DISTINCT CART_PROD, CART_MEMBER FROM CART
		    ) 
		    SELECT
		    	ROWNUM RNUM
			    , PROD_ID
			    , PROD_NAME
			    , PROD_LGU
			    , PROD_BUYER
			    , PROD_COST
			    , PROD_PRICE
			    , PROD_SALE
			    , PROD_OUTLINE
			    , PROD_DETAIL
			    , PROD_IMG
			    , PROD_TOTALSTOCK
			    , PROD_INSDATE
			    , PROD_PROPERSTOCK
			    , PROD_SIZE
			    , PROD_COLOR
			    , PROD_DELIVERY
			    , PROD_UNIT
			    , PROD_QTYIN
			    , PROD_QTYSALE
			    , PROD_MILEAGE
			    , (SELECT COUNT(*) FROM CARTVIEW WHERE CART_PROD = PROD_ID ) BUYER_CNT
			    , BUYER_NAME "buyer.buyerName"
			    , LPROD_NM "lprod.lprodNm"
			FROM
			    PROD INNER JOIN LPROD ON(PROD_LGU = LPROD_GU)
			        INNER JOIN BUYER ON(PROD_BUYER = BUYER_ID)
			) A
            WHERE RNUM BETWEEN 11 AND 20
 -->

